# Chapter 9 labs
## Lab 9-1
This lab's malware is the same as the one we analyzed in Lab 3-4 using basic static and dynamic analysis.

### Advanced Static Analysis
In IDA we see that the malware first checks the number of arguments and jumps to failure code if there are no command line arguments (argc == 1). It then calls 'RegOpenKeyExA' and 'RegQueryValueExA' trying to find a key named "Configuration" at "HKLM\SOFTWARE\Microsoft \XPS". If that key doesn't exist it jumps to the failure code. The failure code gets the name of the running modules using 'GetModuleFileNameA' and crafts a command line string starting with "/c del" and the filename, then passes it to ShellExecuteA: This is how the malware deletes itself when not used successfully. It looks like it must take an argument and if it doesn't get the input it expects it removes itself. Looking as sub_402510, the function that is called if the program is passed at least one argument. This function is passed a pointer to the _last_ command line argument. It first does checks the length of the string using an intrinsic strlen and fails if it isn't 4. It then checks the first character of the string is 'a', that the next character is greater by 1 (so it must be 'b'), that the next is 'c', and finally that the fourth (edx+3) is one greater than that: It looks like the password must be "abcd".

If the password check is successful the program continues to check argv[1] and jumps to a function to handle each of the accepted commands. '-in', '-re', '-c', and '-cc'. The '-in' option installs the service. If there's an extra argument between '-in' and the password then it uses that argument as the service name, otherwise it defaults to the name of the binary. It copies the binary to "%SYSTEMROOT%\system32\" and it registers the service and saves its configuration to "HKLM\SOFTWARE\Microsoft \XPS" (That's "Microsoft" with a space after it). The configuration data includes the strings "ups", "http://www.practicalmalwareanalysis.com", "80", and "60".

The '-re' option works like the install option but removes the service. If a service was installed with a custom name, it must be removed with the custom name, and it uses the number of argument provided to the malware to determine whether it will use the default name of a custom one.

The '-c' option requires argc to be 7, so with the executable's name taking one, the password another, and the command a third, this command appears to take four arguments. These four arguments are passed to sub_401070, the same function that was called from the install option, so these four arguments replace the configuration data that was written to the registry.

The '-cc' option doesn't take any extra arguments. It appears to do nothing more than query the registry for the configuration key and print it to the console.

### Questions
1. We can get this malware to install itself by providing it with the correct set of arguments. It expects a password of 'abcd' as the last argument and it will install if the second argument is '-in'. We can also patch the malware to skip over the password check for convenience, but it was easy to determine what password it was expecting so that's what I did.
2. This malware accepts four different commands:
 -in [service name]: Install the service. Use the binary name if 'service name' is not provided.
 -re [service name]: Remove the service. Use the binary name if 'service name' is not provided.
 -c <k> <h> <p> <per>: Write new configuration to the registry
 -cc: Print out the current configuration.
3. We can simply patch the call to sub_402B1D so that it instead sets eax to 1. Highlight from the push instruction at 0x402B2D to the "add esp, 4" and hit space, and then type in "mov eax, 1" with "Fill with NOP's" checked.
4. The name of the registry key. Notably, it uses "Microsoft" with a space after it. The name of the service also follows a pattern: "<name> Manager Service".
