# Chapter 11 labs
## Lab 11-1
### Basic Static Analysis
- strings: "Software\Microsoft\Windows NT\CurrentVersion\Winlogon", "GinaDLL", "\MSGina", "msgina32.dll", "gina.dll", "??2@YAPAXI@Z", "UN %s DM %s PW %s OLD %s", "msutil32.sys", plus a bunch of imports/exports including 'Wlx*'-named functions.
- PEiD: Unpacked, Microsoft Visual C++ 6.0.
- Dependency Walker: Imports a normal set from KERNEL32.DLL, including 'LoadLibraryA' (probably to load gina.dll) and 'FindResourceA', as well as 'RegCreateKeyExA' and 'RegSetValueExA' from ADVAPI32.DLL.
- PEView: Includes a .rsrc section.
- Resource Hacker: Includes one binary resource which appears to be another PE file.

Running the same analysis on the included resource:
- strings: All of the interesting strings from above were found in the included binary, implying that the binary that held the resource did not contain these strings directly.
- PEiD: Unpacked, Microsoft Visual C++ 6.0 DLL. I renamed the file to 'Lab11-01.resource.dll' with this information.
- Dependency Walker: Imports a small set including 'lstrcatW', 'lstrcpyW', and 'lstrlenW' from KERNEL32.DLL, some low-level functions from MSVCRT.DLL, 'RegCloseKey', 'RegCreateKeyW', and 'RegSetValueExW' from ADVAPI32.DLL, and 'wsprintfA' from USER32.DLL. Appears to export 'DllRegister', 'DllUnregister', 'ShellShutdownDialog', plus a bunch of 'Wlx*'-named functions, implying that this dll implements gina.dll: This malware is very likely used to steal user credentials.
- PEView: Nothing out of the ordinary.

### Basic Dynamic Analysis
Since I didn't see any network-related imports, I just used procmon and Regshot to get a picture of what the malware was doing. In Regshot I see three values added and two values modified. Only one of these changes seem relevant: The key "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GinaDLL" was created with a value "C:\Documents and Settings\Debugger\My Documents\Practical Malware Analysis Labs\BinaryCollection\Chapter_11L\msgina32.dll". Looking at Procmon and we see sure enough that a file called 'msgina32.dll' was created and the registry key was added, but we don't see too much else done. Comparing the md5sum of resource we extracted and this new file we see that they are identical.

### Advanced Static Analysis
Loading the binary into IDA we see a very straightforward process. First it calls 'GetModuleHandleA' with a null argument to get a handle to its own module, and then calls sub_401080. sub_401080 uses the passed handle to grab that module's (its own) resource and then saves it as msgina32.dll. After sub_401080 returns the malware calls 'GetModuleFileNameA' to get the full filename. It then uses '_strchr' to get the location of the last backslash and from than point appends "\msgina32.dll" and then calls sub_401000. sub_401000 is a simple function that simply uses 'RegCreateKeyExA' to write the file path that was created earlier to the registry key "SOFTWARE\Microsoft\Window NT\CurrentVersion\Winlogon'.

Now looking at the DLL we can see quickly it does all of the heavy lifting. Looking at DllMain we see one big branch on _fdwReason_. One branch is for reason DLL_PROCESS_ATTACH and the other is for all other reasons. The attach branch gets the local system directory usinng 'GetSystemDirectoryW', appends "\MSGina" to it, and then calls 'LoadLibraryW' with the resulting string. Once this is done it saves the handle to the global variable IDA called 'hModule'. The other branch checks if the reason is DLL_PROCESS_DETACH and if it is it loads the module handle and then calls 'FreeLibrary'. If the reason is anything else then it just returns.

Since we know this DLL must implement all of the gina.dll exports we will see how it does this. Looking at a few functions we see quickly that the ordinal/function name is simply passed to sub_10001000 most of the time, and then there is a jump to the return value of this function. sub_10001000 seems simple enough: It calls 'GetProcAddess' with the passed function ordinal/name, tests if it is returned an address, and then prints the pointer address into a local buffer and then calls 'ExitProcess' on failure. On success it returns the address of the function. Looking at more functions for something more interesting than a call to sub_10001000, I eventually find WlxLoggedOutSAS.

WlxLoggedOutSAS calls sub_10001000 like every other exported function, but it holds on to the passed pointer and then follows up by allocating 100 bytes with 'new', which was labeled as "??2@YAPAXI@Z" and seen earlier with strings. After 'new' is called it appears to repush all of its arguments and then call the real 'WlxLoggedOutSAS' whose address it received earlier. If 'WlxLoggedOutSAS' doesn't return 1 then it calls sub_10001570, passing it a format string "UN %s DM %s PW %s OLD %s" as well as four pointers it pulled from an array that was in esi. Tracing back to where esi was last written we see that it contains the address of the _pNprNotifyInfo_ argument, and looking on MSDN we see that this argument is indeed a struct that holds the address to four strings: username, domain, password, and old password.

We can take a pretty fair guess and say that sub_10001570 is the function that does the logging, but we need to investigate more to see just where it logs _to_. Looking at this function we see a lot of stack space as well as calls '_vsnwprintf', '_wfopen', and 'fwprintf', as well as the string "msutil32.sys". To avoid wasting time to analyze this more closely I am going to run it to confirm that it logs my password as expected. Because the function that is used to do the logging is 'Wlx__LoggedOut__SAS' it probably won't do anything until I log out and to make sure the malware is loaded I will need to restart the computer first.

Sure enough, if I restart the computer I can find the surreptitiously-named text file "msutil32.sys" in C:\WINDOWS\system32 and it contains my credentials. I noticed immediately, though, that my login screen as well as the shutdown prompt had changed after running the malware. Instead of just the one button to log in and restart, it now had the drop down box and asked me for my credentials. Probably something that is enforced when GINA is used, but I would be curious to see if there could be a way to avoid it so that a victim has would be less likely to notice anything is out of the ordinary.

### Questions
1. The malware reads from its own resource section a dll which it writes to disk as msgina32.dll.
2. The malware writes to the registry's 'GinaDLL' key the address of this new dll.
3. GINA is a system created by Microsoft to allow third parties to customize the login process. Winlogon.exe uses this dll to help authenticate. This malware takes advantage of this feature by implementing the functions required to implement a valid GINA dll so that winlogon.exe will happily pass it any credentials it receives.
4. The malware logs all logoff attempts with a timestamp and the username, group, password, and old password at C:\WINDOWS\system32\msutil32.sys
5. Simply running the malware and then doing a full restart (a simple logout/login didn't work) had my credentials stored in the file.
