# Lab 18
The goal for these labs is simply to unpack the code so that we could proceed with further analysis.

## Lab 18-1
### Basic Static Analysis
- **strings**: Nothing interesting other than some alphabets and imports.
- **PEiD**: Nothing found *.
- **Dependency Walker**: `URLDownloadCacheFileA` from _URLMON.DLL_, `GetUserNameA` from _ADVAPI32.DLL_, `ExitProcess`, `GetProcAddress`, `LoadLibraryA`, `VirtualAlloc`, `VirtualFree`, and `VirtualProtect` from _KERNEL32.DLL_.
- **PEview**: .text, .data, and "UPX2" which suggests it's packed with UPX. Entrypoint is 0x9DC0. With .data's RVA of 0x7000 and size of 0x3000 it falls within there.

### Advanced Static Analysis
IDA only recognizes a single function, `start`. Looking for `jmp` instructions, one in particular stands out: `jmp byte_40154F` at 0x409F43. It's both a long jump, and its target doesn't contain valid instructions.

Setting a bp on this address and then making a single step (avoiding setting a SW breakpoint on code that is changing) indeed hits and goes to what is now normal looking code. Using OllyDump with the default settings I was able to dump the process memory into an executable for analysis in IDA (though IDA warns that the import table is corrupted).

Looking at the now visible strings, I found "http://www.practicalmalwareanalysis.com/%s/%c.png". Grepping for that in my other writeups, I see that the same string was used in Lab 14-1, and can easily verify that they are the same malware.

## Lab 18-2
### Basic Static Analysis
- **strings**: Nothing of interest other than "Init" and two imports.
- **PEiD**: FSG 1.0 -> dulek/xt.
- **Dependency Walker**: Two imports: `GetProcAddress` and `LoadLibraryA` from _KERNEL32.DLL_. This unpacking stub must manually import everything in the original import table.
- **PEview**: No named sections, but two unnamed. Somehow there are headers for three sections. The first section header has no raw data, and is presumably the target where the unpacker will place the malware. Entrypoint is 0x5000, which is an address in the third section.

### Advanced Dynamic/Static Analysis
In this malware, IDA actually identifies three functions in addition to `start`. `sub_40501F` is called immediately, and that function makes all other calls. Placing a breakpoint after the call in `start` hits, meaning that the unpacking functions never make the jump to the OEP. Returning from here actually returns into `sub_40501F`, so unfortunately it won't be that straight forward.

Going back into PEview, we see that the empty section starts at RVA 0x1000. Adding the image base of 0x400000 gives us 0x401000. Putting a **hardware** breakpoint on this address hits, but what is written doesn't appear to be code. Hitting Ctrl-A makes Olly re-analyze the code, though, and it indeed looks legit. Dumping with OllyDump at this point again yields a binary IDA can analyze.

Looking at the strings now, I find "http://www.malwareanalysisbook.com/ad.html". Grepping for this in my writeups I found Lab 7-2 and Lab 10-3. Lab 7-2, however, was the only one that shared the _ole32.dll_ imports, and I can verify that the malware does indeed match.
