# Lab 19

## Lab 19-1
### Basic Static Analysis
- **strings**: A long sequence of "A"s as well as another sequence of seemingly random ascii characters.

### Advanced Static/Dynamic Analysis
Loading the binary into IDA, we see a bunch of 'A' bytes (0x41) which correspond to `inc ecx`, a sort of NOP that remains in the ascii range. After this, there's a call/ret combo to get a pointer to the 'random' ascii string after our main shellcode, and it is pushed back onto the stack. The shellcode appears to decode each byte of this string, by decoding each byte as so: `c[i] = (c[2*i] - 0x41) << 4 + (c[2*i+1] - 0x41)`, meaning each byte of plaintext comes from the bottom nybble of two bytes of ascii. Once this is done, the newly decoded instructions are returned to. To see what this decodes so, I loaded the `shellcode_launcher.exe` into Olly and set the args to load the binary. I then set a hardware breakpoint at 0x350300, which is 0x200 bytes past where it was loaded, but right after where all the 0x41 bytes end. I then walked through until just before the return.

At this point most of the ascii has been decoded into valid instructions, and there are also two strings at the end: "URLMON" and "http://www.practicalmalwareanalysis.com/shellcode/annoy_user.exe". The same call/ret combo is used to get a pointer to the "URLMON" string.

`sub_35039E` is used to find the address of _kernel32.dll_ by parsing the `PEB_LDR_Data` linked list which it finds through the `PEB`, from FS:[0x30].

After this there is a call to a function, `sub_350352`, used to find some functions. It is passed a handle to the module (kernel32 for most) and a hash of the function name, and loops over the functions in the import table, hashing their name `sub_350331`, until it finds a match. It is called repeatedly, finding a handful of different functions, including `LoadLibraryA`. `LoadLibraryA` is used to load URLMON, and then the address of `URLDownloadToFileA` is found using `sub_350352` again. The system path is resolved using `GetSystemDirectoryA` and the _annoy_user.exe_ file is downloaded to _%SYSTEM%/1.exe_, and finally executed.

### Questions
1. The shellcode is encoded by getting each nybble of the original byte and storing it across two bytes, adding 0x41 to each to move it into ASCII range.
2. `LoadLibraryA`, `GetSystemDirectoryA`, `TerminateProcess`, `GetCurrentProcess`, `WinExec`, and `URLDownloadToFileA`.
3. www.practicalmalwareanalysis.com
4. The downloaded file remains at _%SYSTEM%/1.exe_.
5. The shellcode downloads and executes a binary found at http://www.practicalmalwareanalysis.com/shellcode/annoy_user.exe.
