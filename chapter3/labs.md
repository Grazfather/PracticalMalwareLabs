# Chapter 3 labs
## Lab 3-1

1. According to PEid it is packed/encrypted using "PEncrypt 3.1 Final -> junkcode". There are a bunch of readable strings: A few registry keys and application names. PEview only shows two sections: Text and Data, and only one import: ExitProcess from kernel32.dll.
2. I couldn't get AbateDNS to work so I used a python script (https://github.com/Crypt0s/FakeDns) to respond to all DNS requests with localhost as the address. I then set up netcat to listen on ports 80 and 443 (http and https) as suggested by the book and set up Wireshark to listen in on all traffic. Finally, I opened process explorer and procmon to see what the malware was trying to do. When I executed the malware you can see that the process is creating a new file (probably a copy of itself) to _C:\Windows\system32\vmx32to64.exe_ and it then wrote this path to the registry to autorun (HKLM/SOFTWARE/Microsoft/Windows/CurrentVersion/Run/VideoDriver). Viewing 'handles' in procmon we see it creates a mutex (mutant) named WinVMX32.
3. _fakedns.py_ reports a periodic dns request to "www.practicalmalwareanalysis.com" and (after spoofing) connects to my netcat listening on port 443 (https). The data we receive does not look like the start of a https transfer, though, and changes every time it makes a connection. Wireshark seemed to only pick up 'raw' tcp data and it was hard to distinguish from other data. It didn't appear to have anything going localhost->localhost.

## Lab 3-2
### Basic Static Analysis
- strings: A bunch of imports/exports, "practicalmalwareanalysis.com", some service-related error messages, and some registry addresses.
- PEiD: "Microsoft Visual C++ 6.0 DLL [Overlay]"
- Dependency Walker: Exports 'Install', 'ServiceMain', 'UninstallService', 'installA' and 'uninstallA'. Imports a lot, including many calls from _WININET.DLL_ (Http and Internet-related), CreateService, DeleteService, CreateProcess, etc.
- PEview: Normal sections names, date, etc.

### Basic Dynamic Analysis
- Using Regshot and procmon I tracked what registry keys it would modify when run. To protect myself from it auto updating I had fakedns.py running. Since it's clearly a service that needs to be installed I installed it using _rundll32.exe._ Comparing the before and after screenshots I see it added six new keys (in HKLM\SYSTEM\ControlSet001\Services\IPRIP and HKLM\SYSTEM\CurrentControlSet\Services\IPRIP) and 20 values *point to the service dll, name, description, etc. The service appears to be called "Intranet Network Awarenes (INA+)" with a short name of IPRIP.
- Once installed, I set up procmon to track svchost and started the service with `net start IPRIP` and see messages about the service starting. After some time I see a valid HTTP GET request to _practicalmalwareanalysis.com_ on port 80 (which we guessed it would be based on the HTTP methods the DLL imports. In process explorer we can find the instance of _svchost.exe_ that has loaded the malware by searching for the DLL by name. We can also easily find the PID of the svchost instance using `tasklist /svc` to see which install lists 'IPRIP' and find the PID in the column to the left.

### Questions
1. We can install this as a service with _rundll32.exe:_ `rundll32.exe Lab03-02.dll,installA`
2. We can start this service with `net start IPRIP`. We can run `msconfig` to see all installed services, and we can disable it from here, as well.
3. Running `tasklist /svc` from the cmd prompt shows all processes running services, from here we can find IPRIP and find the PID. We can also search for the DLL handle in process explorer to find any processes that have it loaded.
4. We can set a filter in process monitor to only track calls from the PID of the svchost instance that is running out instance, but this would include other services running in this same process.
5. This malware installs as a service that says the manufacturer is "Microsort Corporation" with the name "Intranet Network Awareness (INA+)" and description "Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes.". The service is installed to "HKLM\SYSTEM\CurrentControlSet\Services\IPRIP", where it registers the dll name, location, etc.
6. This malware tries to connect to "practicalmalwareanalysis.com" on port 80 and sends a valid HTTP GET request. The User-Agent is "repc Windows XP 6.11", but in the book it is "MalwareAnalysis2 Windows XP 6.11". Turns out the first part of the User-Agent is just the global environment variable '%ComputerName%'.
