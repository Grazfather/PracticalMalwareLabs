# Chapter 3 labs
## Lab 3-1

1. According to PEid it is packed/encrypted using "PEncrypt 3.1 Final -> junkcode". There are a bunch of readable strings: A few registry keys and application names. PEview only shows two sections: Text and Data, and only one import: ExitProcess from _kernel32.dll_.
2. I couldn't get AbateDNS to work so I used a python script (https://github.com/Crypt0s/FakeDns) to respond to all DNS requests with localhost as the address. I then set up netcat to listen on ports 80 and 443 (http and https) as suggested by the book and set up Wireshark to listen in on all traffic. Finally, I opened process explorer and procmon to see what the malware was trying to do. When I executed the malware you can see that the process is creating a new file (probably a copy of itself) to _C:\Windows\system32\vmx32to64.exe_ and it then wrote this path to the registry to autorun (HKLM/SOFTWARE/Microsoft/Windows/CurrentVersion/Run/VideoDriver). Viewing 'handles' in procmon we see it creates a mutex (mutant) named WinVMX32.
3. fakedns.py reports a periodic dns request to "www.practicalmalwareanalysis.com" and (after spoofing) connects to my netcat listening on port 443 (https). The data we receive does not look like the start of a https transfer, though, and changes every time it makes a connection. Wireshark seemed to only pick up 'raw' tcp data and it was hard to distinguish from other data. It didn't appear to have anything going localhost->localhost.

## Lab 3-2
### Basic Static Analysis
- **strings**: A bunch of imports/exports, "practicalmalwareanalysis.com", some service-related error messages, and some registry addresses.
- **PEiD**: "Microsoft Visual C++ 6.0 DLL [Overlay]"
- **Dependency Walker**: Exports `Install`, `ServiceMain`, `UninstallService`, `installA` and `uninstallA`. Imports a lot, including many calls from _WININET.DLL_ (Http and Internet-related), CreateService, DeleteService, CreateProcess, etc.
- **PEview**: Normal sections names, date, etc.

### Basic Dynamic Analysis
- Using Regshot and procmon I tracked what registry keys it would modify when run. To protect myself from it auto updating I had fakedns.py running. Since it's clearly a service that needs to be installed I installed it using _rundll32.exe._ Comparing the before and after screenshots I see it added six new keys (in HKLM\SYSTEM\ControlSet001\Services\IPRIP and HKLM\SYSTEM\CurrentControlSet\Services\IPRIP) and 20 values *point to the service dll, name, description, etc. The service appears to be called "Intranet Network Awarenes (INA+)" with a short name of IPRIP.
- Once installed, I set up procmon to track svchost and started the service with `net start IPRIP` and see messages about the service starting. After some time I see a valid HTTP GET request to _practicalmalwareanalysis.com_ on port 80 (which we guessed it would be based on the HTTP methods the DLL imports. In process explorer we can find the instance of _svchost.exe_ that has loaded the malware by searching for the DLL by name. We can also easily find the PID of the svchost instance using `tasklist /svc` to see which install lists 'IPRIP' and find the PID in the column to the left.

### Questions
1. We can install this as a service with _rundll32.exe:_ `rundll32.exe Lab03-02.dll,installA`
2. We can start this service with `net start IPRIP`. We can run `msconfig` to see all installed services, and we can disable it from here, as well.
3. Running `tasklist /svc` from the cmd prompt shows all processes running services, from here we can find IPRIP and find the PID. We can also search for the DLL handle in process explorer to find any processes that have it loaded.
4. We can set a filter in process monitor to only track calls from the PID of the svchost instance that is running out instance, but this would include other services running in this same process.
5. This malware installs as a service that says the manufacturer is "Microsort Corporation" with the name "Intranet Network Awareness (INA+)" and description "Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes.". The service is installed to "HKLM\SYSTEM\CurrentControlSet\Services\IPRIP", where it registers the dll name, location, etc.
6. This malware tries to connect to "practicalmalwareanalysis.com" on port 80 and sends a valid HTTP GET request. The User-Agent is "repc Windows XP 6.11", but in the book it is "MalwareAnalysis2 Windows XP 6.11". Turns out the first part of the User-Agent is just the global environment variable '%ComputerName%'.

## Lab 3-3
### Basic Dynamic Analysis
- Setting up procmon to watch for a process called _Lab03-03.exe_ and setting up fakedns.py to block all outgoing dns requests, I simply double clicked the file to see what it did. There are calls to read the binary itself, as well as a bunch of calls to create files such as _svchost.exe._ Looking in process explorer we see an instance of _svchost.exe_ running with no parent, but the parent PID was 3224: The same as the PID of the malware. It appears this malware is trying to replace _svchost.exe_ with its own version, but doesn't seem to replace it on disk. Viewing the properties of the process we see that the strings are very different, including references to _practicalmalwareanalysis.log_. Switching the filter on process explorer to the pid of this new svchost process we see it is writing to a file with this name. Looking at the log file it appears to be logging my keystrokes, including the process that I wrote it in and special characters, though it doesn't seem to catch special characters correctly. Although I found some weird registry entries adding on the second shot in regshot, I don't believe they are related to this keylogger, and it doesn't seem to write to any config files, so the logger shouldn't autorun.

### Questions
1. Using procmon in combination with process explorer I see that it is replacing a new instance of _svchost.exe_ in memory with a new process. The parent PID of this process is the same as the PID that the executable ran with before ending.
2. It tries to create file mappings to _svchost.exe_, which I believe may be to have the subsequent ProcessCreate call execute some malware instead. Looking at this process in memory (particularly the strings) we can see it does not match the strings in the _svchost.exe_ binary on disk.
3. The malware creates a file called _practicalmalwareanalysis.log_.
4. This program is a keylogger. It creates a process called _svchost.exe_ (but that doesn't match C:\WINDOWS\system32\svchost.exe) which logs all key presses to a file in the local directory (of the original malware) named _practicalmalwareanalysis.org_ and writes to this file all of the user's key presses, including the window in which they were focused.

## Lab 3-4
### Basic Static Analysis
- **strings**: references to 'http://www.practicalmalwareanalysys.com', '%SYSTEMROOT%\system32\', what might be commands: 'DOWNLOAD', 'UPLOAD', 'SLEEP', the start of an HTTP header: 'HTTP/1.0', etc, what look like command-line options, plus a bunch of imports.
- **PEiD**: "Microsoft Visual C++ 6.0"
- **Dependency Walker**: Imports a lot, including `ShellExecute`, raw socket stuff from WS2_32.DLL, Service-related imports, Registry-related imports, rw files, etc.
- **PEview**: Normal looking PE other than the huge amount of imports.

### Basic Dynamic Analysis
- We set ourselves up the same as before: reg shot, dns spoofing to localhost, nc on port 80, procmon and process explorer all running. When executed by double-clicking on the binary I see a lot of registry querying as well as reading a bunch of dll files. It also reads its own binary (probably to copy it somewhere). The process runs for only a fraction of a second before closing with status 0. We see it's executing cmd.exe, and if we double click the line in procmon we see that the arguments are to delete the binary itself. Other activity looks benign.

### Questions
1. Closes immediately. On subsequent runs (through cmd) it deletes itself from the disk. Every run _attempts_ to delete the file, but for some reason the attempts fail when double clicked.
2. The malware seems to detect it is not being executed correctly and is terminating immediately (plus attempting to delete the malware).
3. A few dummy tries with the command-line arguments we found in strings ('-in', '-re', '-cc') yielded nothing, but the attempt by the malware to delete itself worked in these cases.
